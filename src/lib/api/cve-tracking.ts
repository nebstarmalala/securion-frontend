/**
 * CVE Tracking API Service
 * Handles all CVE tracking related API calls
 */

import { apiClient, type ApiResponse, type PaginatedResponse } from "./client"
import type {
  ApiCveTracking,
  CreateCveTrackingInput,
  UpdateCveTrackingInput,
  CveTrackingQueryParams,
  PaginatedData,
  CVEStats,
  ListQueryParams,
} from "@/lib/types/api"

class CveTrackingService {
  /**
   * Fetch paginated list of CVE trackings with optional filters
   */
  async getCveTrackings(params?: CveTrackingQueryParams): Promise<PaginatedResponse<ApiCveTracking>> {
    const response = await apiClient.get<PaginatedResponse<ApiCveTracking>>("/cve-trackings", params)
    return response
  }

  /**
   * Fetch a single CVE tracking by ID
   */
  async getCveTracking(id: string): Promise<ApiResponse<ApiCveTracking>> {
    return await apiClient.get<ApiResponse<ApiCveTracking>>(`/cve-trackings/${id}`)
  }

  /**
   * Create a new CVE tracking entry
   */
  async createCveTracking(data: CreateCveTrackingInput): Promise<ApiResponse<ApiCveTracking>> {
    return await apiClient.post<ApiResponse<ApiCveTracking>>("/cve-trackings", data)
  }

  /**
   * Update an existing CVE tracking entry
   */
  async updateCveTracking(id: string, data: UpdateCveTrackingInput): Promise<ApiResponse<ApiCveTracking>> {
    return await apiClient.put<ApiResponse<ApiCveTracking>>(`/cve-trackings/${id}`, data)
  }

  /**
   * Delete a CVE tracking entry
   */
  async deleteCveTracking(id: string): Promise<ApiResponse<void>> {
    return await apiClient.delete<ApiResponse<void>>(`/cve-trackings/${id}`)
  }

  /**
   * Get CVEs by severity level
   */
  async getCvesBySeverity(
    severity: "low" | "medium" | "high" | "critical",
    params?: Omit<CveTrackingQueryParams, "severity">,
  ): Promise<ApiCveTracking[]> {
    const response = await this.getCveTrackings({ ...params, severity })
    return response.data
  }

  /**
   * Get CVEs affecting a specific project
   */
  async getCvesByProject(
    projectId: string,
    params?: Omit<CveTrackingQueryParams, "project_id">,
  ): Promise<ApiCveTracking[]> {
    const response = await this.getCveTrackings({ ...params, project_id: projectId })
    return response.data
  }

  /**
   * Get CVEs affecting a specific scope
   */
  async getCvesByScope(
    scopeId: string,
    params?: Omit<CveTrackingQueryParams, "scope_id">,
  ): Promise<ApiCveTracking[]> {
    const response = await this.getCveTrackings({ ...params, scope_id: scopeId })
    return response.data
  }

  /**
   * Get only CVEs with affected services
   */
  async getAffectedCves(params?: Omit<CveTrackingQueryParams, "affected_only">): Promise<ApiCveTracking[]> {
    const response = await this.getCveTrackings({ ...params, affected_only: true })
    return response.data
  }

  /**
   * Get CVE statistics
   */
  async getCveStatistics(): Promise<ApiResponse<CVEStats>> {
    return await apiClient.get<ApiResponse<CVEStats>>("/cve-trackings/statistics")
  }

  /**
   * Sync CVEs from NVD
   * Rate Limited: 5 requests per hour
   */
  async syncCves(daysBack?: number): Promise<ApiResponse<{ job_id: string }>> {
    return await apiClient.post<ApiResponse<{ job_id: string }>>(
      "/cve-trackings/sync",
      daysBack ? { days_back: daysBack } : {},
    )
  }

  /**
   * Rematch all CVEs to services
   * Rate Limited: 20 requests per minute (bulk operations)
   */
  async rematchAllCves(): Promise<ApiResponse<{ job_id: string }>> {
    return await apiClient.post<ApiResponse<{ job_id: string }>>("/cve-trackings/rematch", {})
  }

  /**
   * Match specific CVE to services
   */
  async matchCveToServices(cveId: string): Promise<ApiResponse<{ matches_found: number }>> {
    return await apiClient.post<ApiResponse<{ matches_found: number }>>(
      `/cve-trackings/${cveId}/match`,
      {},
    )
  }
}

// Export singleton instance
export const cveTrackingService = new CveTrackingService()

// Export legacy function-style API for backwards compatibility
export const getCveTrackings = (params?: CveTrackingQueryParams) => cveTrackingService.getCveTrackings(params)
export const getCveTracking = (id: string) => cveTrackingService.getCveTracking(id)
export const createCveTracking = (data: CreateCveTrackingInput) => cveTrackingService.createCveTracking(data)
export const updateCveTracking = (id: string, data: UpdateCveTrackingInput) =>
  cveTrackingService.updateCveTracking(id, data)
export const deleteCveTracking = (id: string) => cveTrackingService.deleteCveTracking(id)
export const getCvesBySeverity = (
  severity: "low" | "medium" | "high" | "critical",
  params?: Omit<CveTrackingQueryParams, "severity">,
) => cveTrackingService.getCvesBySeverity(severity, params)
export const getCvesByProject = (projectId: string, params?: Omit<CveTrackingQueryParams, "project_id">) =>
  cveTrackingService.getCvesByProject(projectId, params)
export const getCvesByScope = (scopeId: string, params?: Omit<CveTrackingQueryParams, "scope_id">) =>
  cveTrackingService.getCvesByScope(scopeId, params)
export const getAffectedCves = (params?: Omit<CveTrackingQueryParams, "affected_only">) =>
  cveTrackingService.getAffectedCves(params)
