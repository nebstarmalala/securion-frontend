/**
 * React Query Hooks for CVE Tracking
 * Provides data fetching, caching, and mutation hooks for CVE tracking operations
 */

import { useQuery, useMutation, useQueryClient, type UseQueryOptions } from "@tanstack/react-query"
import { cveTrackingService } from "@/lib/api"
import type {
  ApiCveTracking,
  CreateCveTrackingInput,
  UpdateCveTrackingInput,
  CveTrackingQueryParams,
  PaginatedData,
} from "@/lib/types/api"
import type { ApiResponse } from "@/lib/api"
import { useToast } from "@/hooks/use-toast"

// Query Keys
export const cveTrackingKeys = {
  all: ["cve-trackings"] as const,
  lists: () => [...cveTrackingKeys.all, "list"] as const,
  list: (params?: CveTrackingQueryParams) => [...cveTrackingKeys.lists(), params] as const,
  details: () => [...cveTrackingKeys.all, "detail"] as const,
  detail: (id: string) => [...cveTrackingKeys.details(), id] as const,
  bySeverity: (severity: string) => [...cveTrackingKeys.all, "severity", severity] as const,
  byProject: (projectId: string) => [...cveTrackingKeys.all, "project", projectId] as const,
  byScope: (scopeId: string) => [...cveTrackingKeys.all, "scope", scopeId] as const,
}

/**
 * Fetch paginated list of CVE trackings
 */
export function useCveTrackings(
  params?: CveTrackingQueryParams,
  options?: Omit<
    UseQueryOptions<PaginatedData<ApiCveTracking>>,
    "queryKey" | "queryFn"
  >,
) {
  return useQuery({
    queryKey: cveTrackingKeys.list(params),
    queryFn: () => cveTrackingService.getCveTrackings(params),
    ...options,
  })
}

/**
 * Fetch a single CVE tracking by ID
 */
export function useCveTracking(
  id: string,
  options?: Omit<UseQueryOptions<ApiCveTracking>, "queryKey" | "queryFn">,
) {
  return useQuery({
    queryKey: cveTrackingKeys.detail(id),
    queryFn: async () => {
      const response = await cveTrackingService.getCveTracking(id)
      return response.data
    },
    enabled: !!id,
    ...options,
  })
}

/**
 * Fetch CVEs by severity level
 */
export function useCvesBySeverity(
  severity: "low" | "medium" | "high" | "critical",
  params?: Omit<CveTrackingQueryParams, "severity">,
) {
  return useQuery({
    queryKey: cveTrackingKeys.bySeverity(severity),
    queryFn: () => cveTrackingService.getCvesBySeverity(severity, params),
  })
}

/**
 * Fetch CVEs affecting a specific project
 */
export function useCvesByProject(
  projectId: string,
  params?: Omit<CveTrackingQueryParams, "project_id">,
) {
  return useQuery({
    queryKey: cveTrackingKeys.byProject(projectId),
    queryFn: () => cveTrackingService.getCvesByProject(projectId, params),
    enabled: !!projectId,
  })
}

/**
 * Fetch CVEs affecting a specific scope
 */
export function useCvesByScope(
  scopeId: string,
  params?: Omit<CveTrackingQueryParams, "scope_id">,
) {
  return useQuery({
    queryKey: cveTrackingKeys.byScope(scopeId),
    queryFn: () => cveTrackingService.getCvesByScope(scopeId, params),
    enabled: !!scopeId,
  })
}

/**
 * Create a new CVE tracking entry
 */
export function useCreateCveTracking() {
  const queryClient = useQueryClient()
  const { toast } = useToast()

  return useMutation({
    mutationFn: async (data: CreateCveTrackingInput) => {
      const response = await cveTrackingService.createCveTracking(data)
      return response
    },
    onSuccess: (response) => {
      queryClient.invalidateQueries({ queryKey: cveTrackingKeys.lists() })
      toast({
        title: "CVE Tracking Created",
        description: response.message || "CVE tracking entry has been created successfully.",
      })
    },
    onError: (error: any) => {
      toast({
        title: "Error",
        description: error.message || "Failed to create CVE tracking entry.",
        variant: "destructive",
      })
    },
  })
}

/**
 * Update an existing CVE tracking entry
 */
export function useUpdateCveTracking() {
  const queryClient = useQueryClient()
  const { toast } = useToast()

  return useMutation({
    mutationFn: async ({ id, data }: { id: string; data: UpdateCveTrackingInput }) => {
      const response = await cveTrackingService.updateCveTracking(id, data)
      return response
    },
    onSuccess: (response, variables) => {
      queryClient.invalidateQueries({ queryKey: cveTrackingKeys.detail(variables.id) })
      queryClient.invalidateQueries({ queryKey: cveTrackingKeys.lists() })
      toast({
        title: "CVE Tracking Updated",
        description: response.message || "CVE tracking entry has been updated successfully.",
      })
    },
    onError: (error: any) => {
      toast({
        title: "Error",
        description: error.message || "Failed to update CVE tracking entry.",
        variant: "destructive",
      })
    },
  })
}

/**
 * Delete a CVE tracking entry
 */
export function useDeleteCveTracking() {
  const queryClient = useQueryClient()
  const { toast } = useToast()

  return useMutation({
    mutationFn: async (id: string) => {
      const response = await cveTrackingService.deleteCveTracking(id)
      return response
    },
    onSuccess: (response) => {
      queryClient.invalidateQueries({ queryKey: cveTrackingKeys.lists() })
      toast({
        title: "CVE Tracking Deleted",
        description: response.message || "CVE tracking entry has been deleted successfully.",
      })
    },
    onError: (error: any) => {
      toast({
        title: "Error",
        description: error.message || "Failed to delete CVE tracking entry.",
        variant: "destructive",
      })
    },
  })
}

/**
 * Fetch CVE statistics
 */
export function useCveStatistics() {
  return useQuery({
    queryKey: [...cveTrackingKeys.all, "statistics"],
    queryFn: async () => {
      const response = await cveTrackingService.getCveStatistics()
      return response
    },
  })
}

/**
 * Sync CVEs from NVD
 */
export function useSyncCves() {
  const queryClient = useQueryClient()
  const { toast } = useToast()

  return useMutation({
    mutationFn: async (daysBack?: number) => {
      const response = await cveTrackingService.syncCves(daysBack)
      return response
    },
    onSuccess: (response) => {
      queryClient.invalidateQueries({ queryKey: cveTrackingKeys.lists() })
      queryClient.invalidateQueries({ queryKey: [...cveTrackingKeys.all, "statistics"] })
      toast({
        title: "CVE Sync Started",
        description: response.message || "CVE sync job has been queued successfully.",
      })
    },
    onError: (error: any) => {
      toast({
        title: "Sync Failed",
        description: error.message || "Failed to start CVE sync.",
        variant: "destructive",
      })
    },
  })
}

/**
 * Rematch all CVEs to services
 */
export function useRematchCves() {
  const queryClient = useQueryClient()
  const { toast } = useToast()

  return useMutation({
    mutationFn: async () => {
      const response = await cveTrackingService.rematchAllCves()
      return response
    },
    onSuccess: (response) => {
      queryClient.invalidateQueries({ queryKey: cveTrackingKeys.lists() })
      queryClient.invalidateQueries({ queryKey: [...cveTrackingKeys.all, "statistics"] })
      toast({
        title: "CVE Rematch Started",
        description: response.message || "CVE rematch job has been queued successfully.",
      })
    },
    onError: (error: any) => {
      toast({
        title: "Rematch Failed",
        description: error.message || "Failed to start CVE rematch.",
        variant: "destructive",
      })
    },
  })
}

/**
 * Match specific CVE to services
 */
export function useMatchCve() {
  const queryClient = useQueryClient()
  const { toast } = useToast()

  return useMutation({
    mutationFn: async (cveId: string) => {
      const response = await cveTrackingService.matchCveToServices(cveId)
      return response
    },
    onSuccess: (response, cveId) => {
      queryClient.invalidateQueries({ queryKey: cveTrackingKeys.detail(cveId) })
      queryClient.invalidateQueries({ queryKey: cveTrackingKeys.lists() })
      toast({
        title: "CVE Matched",
        description: `Found ${response.data.matches_found} matching services.`,
      })
    },
    onError: (error: any) => {
      toast({
        title: "Match Failed",
        description: error.message || "Failed to match CVE to services.",
        variant: "destructive",
      })
    },
  })
}
